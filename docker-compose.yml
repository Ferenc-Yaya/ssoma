services:
  postgres:
    image: postgres:15-alpine
    container_name: ssoma-postgres
    environment:
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ssoma-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: ssoma-auth-service
    ports:
      - "8082:8082"
    environment:
      SERVER_PORT: 8082
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      JWT_SECRET: mi_secreto_jwt_super_seguro_2025
      JWT_EXPIRATION: 86400000
    depends_on:
      postgres:
        condition: service_healthy

  personas-service:
    build:
      context: .
      dockerfile: personas-service/Dockerfile
    container_name: ssoma-personas-service
    ports:
      - "8083:8083"
    environment:
      SERVER_PORT: 8083
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  activos-service:
    build:
      context: .
      dockerfile: activos-service/Dockerfile
    container_name: ssoma-activos-service
    ports:
      - "8084:8084"
    environment:
      SERVER_PORT: 8084
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  documental-service:
    build:
      context: .
      dockerfile: documental-service/Dockerfile
    container_name: ssoma-documental-service
    ports:
      - "8085:8085"
    environment:
      SERVER_PORT: 8085
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  bpm-service:
    build:
      context: .
      dockerfile: bpm-service/Dockerfile
    container_name: ssoma-bpm-service
    ports:
      - "8086:8086"
    environment:
      SERVER_PORT: 8086
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  compliance-service:
    build:
      context: .
      dockerfile: compliance-service/Dockerfile
    container_name: ssoma-compliance-service
    ports:
      - "8087:8087"
    environment:
      SERVER_PORT: 8087
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  notifications-service:
    build:
      context: .
      dockerfile: notifications-service/Dockerfile
    container_name: ssoma-notifications-service
    ports:
      - "8088:8088"
    environment:
      SERVER_PORT: 8088
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  empresas-service:
    build:
      context: .
      dockerfile: empresas-service/Dockerfile
    container_name: ssoma-empresas-service
    ports:
      - "8089:8089"
    environment:
      SERVER_PORT: 8089
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ssoma_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    depends_on:
      postgres:
        condition: service_healthy

  gateway-service:
    build:
      context: .
      dockerfile: gateway-service/Dockerfile
    container_name: ssoma-gateway
    ports:
      - "8080:8080"
    environment:
      SERVER_PORT: 8080
      JWT_SECRET: mi_secreto_jwt_super_seguro_2025
      AUTH_SERVICE_URL: http://auth-service:8082
      PERSONAS_SERVICE_URL: http://personas-service:8083
      ACTIVOS_SERVICE_URL: http://activos-service:8084
      DOCUMENTAL_SERVICE_URL: http://documental-service:8085
      BPM_SERVICE_URL: http://bpm-service:8086
      COMPLIANCE_SERVICE_URL: http://compliance-service:8087
      NOTIFICATIONS_SERVICE_URL: http://notifications-service:8088
      EMPRESAS_SERVICE_URL: http://empresas-service:8089
    depends_on:
      - auth-service
      - personas-service
      - activos-service
      - documental-service
      - bpm-service
      - compliance-service
      - notifications-service
      - empresas-service

volumes:
  postgres_data: