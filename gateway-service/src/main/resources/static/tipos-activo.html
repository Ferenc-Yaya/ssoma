<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tipos de Activo - Sistema SSOMA</title>
</head>
<body>
<h1>Gestión de Tipos de Activo</h1>

<p><a href="home.html">← Volver al Inicio</a></p>

<hr>

<h2>Crear/Actualizar Tipo de Activo</h2>
<form id="tipoActivoForm">
    <input type="hidden" id="tipoId">

    <p>
        <label>Código:</label><br>
        <input type="text" id="codigo" required>
    </p>

    <p>
        <label>Nombre:</label><br>
        <input type="text" id="nombre" required>
    </p>

    <p>
        <label>Descripción:</label><br>
        <textarea id="descripcion" rows="3"></textarea>
    </p>

    <p>
        <label>
            <input type="checkbox" id="activo" checked>
            Activo
        </label>
    </p>

    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarFormulario()">Limpiar</button>
</form>

<hr>

<h2>Lista de Tipos de Activo</h2>
<button onclick="cargarTipos()">Recargar Lista</button>
<div id="listaTipos"></div>

<script>
    const API_URL = 'http://localhost:8080/api/activos/tipos-activo';

    // Verificar token al cargar
    window.onload = function() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert('Debe iniciar sesión primero');
            window.location.href = 'login.html';
            return;
        }
        cargarTipos();
    };

    function getToken() {
        return localStorage.getItem('jwt_token');
    }

    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        };
    }

    async function cargarTipos() {
        try {
            const response = await fetch(API_URL, {
                headers: getHeaders()
            });

            if (response.ok) {
                const tipos = await response.json();
                mostrarTipos(tipos);
            } else {
                document.getElementById('listaTipos').innerHTML = '<p style="color:red">Error al cargar tipos</p>';
            }
        } catch (error) {
            document.getElementById('listaTipos').innerHTML = '<p style="color:red">Error: ' + error.message + '</p>';
        }
    }

    function mostrarTipos(tipos) {
        let html = '<table border="1" cellpadding="5" cellspacing="0">';
        html += '<tr><th>Código</th><th>Nombre</th><th>Descripción</th><th>Activo</th><th>Acciones</th></tr>';

        tipos.forEach(tipo => {
            html += `<tr>
                <td>${tipo.codigo}</td>
                <td>${tipo.nombre}</td>
                <td>${tipo.descripcion || ''}</td>
                <td>${tipo.activo ? 'Sí' : 'No'}</td>
                <td>
                    <button onclick='editar(${JSON.stringify(tipo)})'>Editar</button>
                    <button onclick='eliminar("${tipo.tipoId}")'>Eliminar</button>
                </td>
            </tr>`;
        });

        html += '</table>';
        document.getElementById('listaTipos').innerHTML = html;
    }

    document.getElementById('tipoActivoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const tipoId = document.getElementById('tipoId').value;
        const data = {
            codigo: document.getElementById('codigo').value,
            nombre: document.getElementById('nombre').value,
            descripcion: document.getElementById('descripcion').value,
            activo: document.getElementById('activo').checked
        };

        try {
            const url = tipoId ? `${API_URL}/${tipoId}` : API_URL;
            const method = tipoId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: getHeaders(),
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert(tipoId ? 'Tipo actualizado exitosamente' : 'Tipo creado exitosamente');
                limpiarFormulario();
                cargarTipos();
            } else {
                alert('Error al guardar');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    function editar(tipo) {
        document.getElementById('tipoId').value = tipo.tipoId;
        document.getElementById('codigo').value = tipo.codigo;
        document.getElementById('nombre').value = tipo.nombre;
        document.getElementById('descripcion').value = tipo.descripcion || '';
        document.getElementById('activo').checked = tipo.activo;
    }

    async function eliminar(tipoId) {
        if (!confirm('¿Está seguro de eliminar este tipo?')) return;

        try {
            const response = await fetch(`${API_URL}/${tipoId}`, {
                method: 'DELETE',
                headers: getHeaders()
            });

            if (response.ok) {
                alert('Tipo eliminado exitosamente');
                cargarTipos();
            } else {
                alert('Error al eliminar');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    function limpiarFormulario() {
        document.getElementById('tipoActivoForm').reset();
        document.getElementById('tipoId').value = '';
        document.getElementById('activo').checked = true;
    }
</script>
</body>
</html>