<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Activos - Sistema SSOMA</title>
</head>
<body>
<h1>Gestión de Activos</h1>

<p><a href="home.html">← Volver al Inicio</a> |
    <a href="categorias-activo.html">Categorías</a> |
    <a href="operadores.html">Operadores</a></p>

<hr>

<h2>Crear/Actualizar Activo</h2>
<form id="activoForm">
    <input type="hidden" id="activoId">

    <p>
        <label>Categoría:</label><br>
        <select id="categoriaId" required>
            <option value="">Seleccione...</option>
        </select>
    </p>

    <p>
        <label>Código:</label><br>
        <input type="text" id="codigo">
    </p>

    <p>
        <label>Nombre:</label><br>
        <input type="text" id="nombre">
    </p>

    <p>
        <label>Descripción:</label><br>
        <textarea id="descripcion" rows="3"></textarea>
    </p>

    <p>
        <label>Operadores (seleccione múltiples con Ctrl/Cmd):</label><br>
        <select id="operadores" multiple size="5" style="width:300px">
        </select>
    </p>

    <p>
        <label>
            <input type="checkbox" id="activo" checked>
            Activo
        </label>
    </p>

    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarFormulario()">Limpiar</button>
</form>

<hr>

<h2>Lista de Activos</h2>
<button onclick="cargarActivos()">Recargar Lista</button>
<div id="listaActivos"></div>

<script>
    const API_URL = 'http://localhost:8080/api/activos/activos';
    const CATEGORIAS_URL = 'http://localhost:8080/api/activos/categorias-activo';
    const OPERADORES_URL = 'http://localhost:8080/api/activos/operadores';

    window.onload = function() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert('Debe iniciar sesión primero');
            window.location.href = 'login.html';
            return;
        }
        cargarCategorias();
        cargarOperadores();
        cargarActivos();
    };

    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
        };
    }

    async function cargarCategorias() {
        try {
            const response = await fetch(CATEGORIAS_URL, { headers: getHeaders() });
            if (response.ok) {
                const categorias = await response.json();
                const select = document.getElementById('categoriaId');
                categorias.forEach(cat => {
                    if (cat.activo) {
                        const option = document.createElement('option');
                        option.value = cat.categoriaId;
                        option.text = cat.nombre + ' (' + (cat.tipoNombre || '') + ')';
                        select.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Error cargando categorías:', error);
        }
    }

    async function cargarOperadores() {
        try {
            const response = await fetch(OPERADORES_URL, { headers: getHeaders() });
            if (response.ok) {
                const operadores = await response.json();
                const select = document.getElementById('operadores');
                operadores.forEach(op => {
                    if (op.activo) {
                        const option = document.createElement('option');
                        option.value = op.operadorId;
                        option.text = op.nombre + (op.documento ? ' - ' + op.documento : '');
                        select.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Error cargando operadores:', error);
        }
    }

    async function cargarActivos() {
        try {
            const response = await fetch(API_URL, { headers: getHeaders() });
            if (response.ok) {
                const activos = await response.json();
                mostrarActivos(activos);
            } else {
                document.getElementById('listaActivos').innerHTML = '<p style="color:red">Error al cargar</p>';
            }
        } catch (error) {
            document.getElementById('listaActivos').innerHTML = '<p style="color:red">Error: ' + error.message + '</p>';
        }
    }

    function mostrarActivos(activos) {
        let html = '<table border="1" cellpadding="5" cellspacing="0">';
        html += '<tr><th>Código</th><th>Nombre</th><th>Categoría</th><th>Tipo</th><th>Operadores</th><th>Activo</th><th>Acciones</th></tr>';

        activos.forEach(activo => {
            const operadores = activo.operadores ? activo.operadores.map(o => o.nombre).join(', ') : '';
            html += `<tr>
                <td>${activo.codigo || ''}</td>
                <td>${activo.nombre || ''}</td>
                <td>${activo.categoriaNombre || ''}</td>
                <td>${activo.tipoNombre || ''}</td>
                <td>${operadores}</td>
                <td>${activo.activo ? 'Sí' : 'No'}</td>
                <td>
                    <button onclick='verDetalle("${activo.activoId}")'>Ver</button>
                    <button onclick='eliminar("${activo.activoId}")'>Eliminar</button>
                    <button onclick='toggleActivo("${activo.activoId}")'>Toggle</button>
                </td>
            </tr>`;
        });

        html += '</table>';
        document.getElementById('listaActivos').innerHTML = html;
    }

    document.getElementById('activoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const activoId = document.getElementById('activoId').value;

        // Obtener operadores seleccionados
        const selectOperadores = document.getElementById('operadores');
        const operadores = Array.from(selectOperadores.selectedOptions).map(opt => ({
            operadorId: opt.value
        }));

        const data = {
            categoriaId: document.getElementById('categoriaId').value,
            codigo: document.getElementById('codigo').value,
            nombre: document.getElementById('nombre').value,
            descripcion: document.getElementById('descripcion').value,
            operadores: operadores,
            activo: document.getElementById('activo').checked
        };

        try {
            const url = activoId ? `${API_URL}/${activoId}` : API_URL;
            const method = activoId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: getHeaders(),
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert(activoId ? 'Activo actualizado' : 'Activo creado');
                limpiarFormulario();
                cargarActivos();
            } else {
                const errorText = await response.text();
                alert('Error al guardar: ' + errorText);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    async function verDetalle(activoId) {
        try {
            const response = await fetch(`${API_URL}/${activoId}`, { headers: getHeaders() });
            if (response.ok) {
                const activo = await response.json();
                let detalle = `
    === DETALLE DEL ACTIVO ===

    Código: ${activo.codigo || 'N/A'}
    Nombre: ${activo.nombre || 'N/A'}
    Categoría: ${activo.categoriaNombre || 'N/A'}
    Tipo: ${activo.tipoNombre || 'N/A'}
    Descripción: ${activo.descripcion || 'N/A'}
    Fecha Registro: ${activo.fechaRegistro || 'N/A'}
    Activo: ${activo.activo ? 'Sí' : 'No'}

    OPERADORES:
    `;
                if (activo.operadores && activo.operadores.length > 0) {
                    activo.operadores.forEach(op => {
                        detalle += `- ${op.nombre} (${op.documento || 'Sin doc'})\n`;
                    });
                } else {
                    detalle += 'Sin operadores asignados\n';
                }

                detalle += '\nREQUISITOS:\n';
                if (activo.requisitos && activo.requisitos.length > 0) {
                    activo.requisitos.forEach(req => {
                        detalle += `- ${req.requisitoNombre} [${req.requisitoCodigo}] - Cumple: ${req.cumple ? 'Sí' : 'No'}\n`;
                    });
                } else {
                    detalle += 'Sin requisitos\n';
                }

                alert(detalle);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function eliminar(activoId) {
        if (!confirm('¿Eliminar este activo?')) return;

        try {
            const response = await fetch(`${API_URL}/${activoId}`, {
                method: 'DELETE',
                headers: getHeaders()
            });

            if (response.ok) {
                alert('Activo eliminado');
                cargarActivos();
            } else {
                alert('Error al eliminar');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function toggleActivo(activoId) {
        try {
            const response = await fetch(`${API_URL}/${activoId}/toggle-activo`, {
                method: 'PATCH',
                headers: getHeaders()
            });

            if (response.ok) {
                alert('Estado actualizado');
                cargarActivos();
            } else {
                alert('Error al actualizar estado');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    function limpiarFormulario() {
        document.getElementById('activoForm').reset();
        document.getElementById('activoId').value = '';
        document.getElementById('activo').checked = true;

        // Limpiar selección de operadores
        const selectOperadores = document.getElementById('operadores');
        for (let i = 0; i < selectOperadores.options.length; i++) {
            selectOperadores.options[i].selected = false;
        }
    }
</script>
</body>
</html>