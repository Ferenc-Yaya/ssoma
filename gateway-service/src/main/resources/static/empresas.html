<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Empresas - SSOMA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .seccion { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .contacto-item, .servicio-item { background: #f5f5f5; padding: 10px; margin: 5px 0; border-left: 3px solid #007bff; }
        .btn { padding: 8px 15px; margin: 5px; cursor: pointer; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-secondary { background: #6c757d; color: white; border: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; font-weight: bold; }
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mensaje.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        input, select, textarea { padding: 5px; margin: 3px 0; width: 100%; max-width: 400px; }
        .radio-group { display: flex; gap: 20px; margin: 10px 0; }
        .radio-item { display: flex; align-items: center; cursor: pointer; }
        .radio-item input[type="radio"] { width: auto; margin-right: 8px; }
    </style>
</head>
<body>

<h1>üè¢ Gesti√≥n de Empresas Contratistas - SSOMA</h1>

<!-- ============================================ -->
<!-- FORMULARIO DE CREACI√ìN/EDICI√ìN -->
<!-- ============================================ -->
<div class="seccion">
    <h2 id="formTitle">‚ú® Crear Nueva Empresa</h2>
    <form id="empresaForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="empresaId">

        <!-- DATOS B√ÅSICOS -->
        <h3>üìã Datos B√°sicos</h3>
        <p>
            <label><strong>RUC:</strong> (m√°ximo 20 caracteres) *</label><br>
            <input type="text" id="ruc" maxlength="20" required>
        </p>
        <p>
            <label><strong>Raz√≥n Social:</strong> *</label><br>
            <input type="text" id="razonSocial" maxlength="200" required>
        </p>
        <p>
            <label><strong>Direcci√≥n:</strong></label><br>
            <input type="text" id="direccion" maxlength="255">
        </p>
        <p>
            <label><strong>Sector:</strong></label><br>
            <select id="sector">
                <option value="">Seleccione...</option>
                <option value="Construcci√≥n">Construcci√≥n</option>
                <option value="Miner√≠a">Miner√≠a</option>
                <option value="Manufactura">Manufactura</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                <option value="Servicios">Servicios</option>
                <option value="Agricultura">Agricultura</option>
                <option value="Comercio">Comercio</option>
                <option value="Transporte">Transporte</option>
                <option value="Energ√≠a">Energ√≠a</option>
                <option value="Otros">Otros</option>
            </select>
        </p>
        <p>
            <label><strong>Score de Seguridad SSOMA (0-100):</strong></label><br>
            <input type="number" id="scoreSeguridad" min="0" max="100">
        </p>

        <!-- CONTACTOS -->
        <h3>üìû Contactos</h3>
        <div id="contactosList"></div>
        <button type="button" class="btn btn-secondary" onclick="agregarContacto()">+ Agregar Contacto</button>

        <!-- SERVICIOS -->
        <h3>üîß Servicios que Ofrece</h3>
        <div id="serviciosList"></div>
        <button type="button" class="btn btn-secondary" onclick="agregarServicio()">+ Agregar Servicio</button>

        <!-- TIPOS DE CONTRATISTA - RADIO BUTTONS -->
        <h3>üë∑ Tipo de Contratista *</h3>
        <div id="tiposContratistaList" class="radio-group">
            <p>Cargando tipos de contratista...</p>
        </div>

        <br><br>
        <button type="submit" class="btn btn-primary" id="submitBtn">Crear Empresa</button>
        <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="cancelarEdicion()" style="display:none">Cancelar</button>
    </form>
</div>

<!-- ============================================ -->
<!-- LISTA DE EMPRESAS -->
<!-- ============================================ -->
<div class="seccion">
    <h2>üìä Lista de Empresas</h2>
    <button class="btn btn-primary" onclick="cargarEmpresas()">üîÑ Recargar</button>
    <button class="btn btn-success" onclick="mostrarSoloActivas()">‚úÖ Solo Activas</button>

    <div id="mensajeContainer"></div>

    <table>
        <thead>
        <tr>
            <th>RUC</th>
            <th>Raz√≥n Social</th>
            <th>Sector</th>
            <th>Score</th>
            <th>Contactos</th>
            <th>Servicios</th>
            <th>Tipo</th>
            <th>Activo</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="empresasTableBody">
        <tr><td colspan="9" style="text-align:center;">Cargando empresas...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let contactosArray = [];
    let serviciosArray = [];
    let tiposContratistaGlobal = [];
    let editandoEmpresaId = null;

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
        await cargarTiposContratista();
        await cargarEmpresas();
    });

    // ============================================
    // FUNCIONES DE CARGA DE DATOS
    // ============================================
    async function cargarTiposContratista() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas/tipos-contratista', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                tiposContratistaGlobal = await response.json();
                mostrarTiposContratista();
            } else {
                throw new Error('No se pudieron cargar tipos');
            }
        } catch (error) {
            console.error('Error al cargar tipos:', error);
            mostrarMensaje('Error al cargar tipos de contratista', 'error');
        }
    }

    function mostrarTiposContratista() {
        const container = document.getElementById('tiposContratistaList');

        if (!tiposContratistaGlobal || tiposContratistaGlobal.length === 0) {
            container.innerHTML = '<p style="color: red;">No se pudieron cargar los tipos de contratista</p>';
            return;
        }

        // Crear radio buttons (solo UNO puede ser seleccionado)
        container.innerHTML = tiposContratistaGlobal.map(tipo => `
            <label class="radio-item">
                <input type="radio" name="tipoContratista" value="${tipo.tipoId}" required>
                <span>${tipo.nombre}</span>
            </label>
        `).join('');
    }

    async function cargarEmpresas() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresas = await response.json();
                renderizarTabla(empresas);
            } else {
                throw new Error('Error al cargar empresas');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar las empresas', 'error');
        }
    }

    async function mostrarSoloActivas() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresas = await response.json();
                const activas = empresas.filter(e => e.activo);
                renderizarTabla(activas);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // ============================================
    // RENDERIZADO DE TABLA
    // ============================================
    function renderizarTabla(empresas) {
        const tbody = document.getElementById('empresasTableBody');

        if (empresas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No hay empresas registradas</td></tr>';
            return;
        }

        tbody.innerHTML = empresas.map(empresa => {
            const contactosStr = empresa.contactos && empresa.contactos.length > 0
                ? empresa.contactos.map(c => c.nombreContacto || 'Sin nombre').join(', ')
                : 'Sin contactos';

            const serviciosStr = empresa.servicios && empresa.servicios.length > 0
                ? empresa.servicios.map(s => s.descripcionServicio).join(', ')
                : 'Sin servicios';

            const tiposStr = empresa.tipos && empresa.tipos.length > 0
                ? empresa.tipos.map(t => t.nombre).join(', ')
                : 'Sin tipo';

            const estadoIcono = empresa.activo ? '‚úÖ S√≠' : '‚ùå No';
            const estadoColor = empresa.activo ? '#28a745' : '#dc3545';

            return `
                <tr style="${empresa.activo ? '' : 'opacity: 0.6; background-color: #f8f9fa;'}">
                    <td>${empresa.ruc}</td>
                    <td>${empresa.razonSocial}</td>
                    <td>${empresa.sector || '-'}</td>
                    <td>${empresa.scoreSeguridad || '-'}</td>
                    <td style="font-size: 0.9em;">${contactosStr}</td>
                    <td style="font-size: 0.9em;">${serviciosStr}</td>
                    <td>${tiposStr}</td>
                    <td style="text-align: center; color: ${estadoColor}; font-weight: bold;">
                        ${estadoIcono}
                    </td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary"
                                onclick="editarEmpresa('${empresa.empresaId}')"
                                ${!empresa.activo ? 'disabled' : ''}>
                            Editar
                        </button>
                        <button class="btn ${empresa.activo ? 'btn-secondary' : 'btn-success'}"
                                onclick="toggleActivoEmpresa('${empresa.empresaId}', ${empresa.activo})"
                                title="${empresa.activo ? 'Desactivar empresa' : 'Activar empresa'}">
                            ${empresa.activo ? 'üîí Inactivar' : '‚úÖ Activar'}
                        </button>
                        <button class="btn btn-danger"
                                onclick="eliminarEmpresa('${empresa.empresaId}')"
                                ${!empresa.activo ? 'disabled' : ''}>
                            Eliminar
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============================================
    // GESTI√ìN DE CONTACTOS
    // ============================================
    function agregarContacto() {
        const index = contactosArray.length;
        contactosArray.push({ nombreContacto: '', telefono: '', email: '', esPrincipal: false });
        renderContactos();
    }

    function eliminarContacto(index) {
        contactosArray.splice(index, 1);
        renderContactos();
    }

    function renderContactos() {
        const container = document.getElementById('contactosList');

        if (contactosArray.length === 0) {
            container.innerHTML = '<p style="color: #999;">No hay contactos agregados.</p>';
            return;
        }

        container.innerHTML = contactosArray.map((contacto, index) => `
            <div class="contacto-item">
                <strong>Contacto ${index + 1}</strong>
                <button type="button" class="btn btn-danger" style="float: right; padding: 5px 10px;" onclick="eliminarContacto(${index})">Eliminar</button>
                <br><br>
                <label>Nombre:</label><br>
                <input type="text" value="${contacto.nombreContacto || ''}"
                       onchange="contactosArray[${index}].nombreContacto = this.value">
                <br>
                <label>Tel√©fono:</label><br>
                <input type="text" value="${contacto.telefono || ''}"
                       onchange="contactosArray[${index}].telefono = this.value">
                <br>
                <label>Email:</label><br>
                <input type="email" value="${contacto.email || ''}"
                       onchange="contactosArray[${index}].email = this.value">
                <br>
                <label style="display: flex; align-items: center; margin-top: 5px;">
                    <input type="checkbox" ${contacto.esPrincipal ? 'checked' : ''}
                           onchange="contactosArray[${index}].esPrincipal = this.checked"
                           style="width: auto; margin-right: 5px;">
                    Es contacto principal
                </label>
            </div>
        `).join('');
    }

    // ============================================
    // GESTI√ìN DE SERVICIOS
    // ============================================
    function agregarServicio() {
        const index = serviciosArray.length;
        serviciosArray.push({ descripcionServicio: '', nivelRiesgo: 'BAJO' });
        renderServicios();
    }

    function eliminarServicio(index) {
        serviciosArray.splice(index, 1);
        renderServicios();
    }

    function renderServicios() {
        const container = document.getElementById('serviciosList');

        if (serviciosArray.length === 0) {
            container.innerHTML = '<p style="color: #999;">No hay servicios agregados.</p>';
            return;
        }

        container.innerHTML = serviciosArray.map((servicio, index) => `
            <div class="servicio-item">
                <strong>Servicio ${index + 1}</strong>
                <button type="button" class="btn btn-danger" style="float: right; padding: 5px 10px;" onclick="eliminarServicio(${index})">Eliminar</button>
                <br><br>
                <label>Descripci√≥n del servicio:</label><br>
                <input type="text" value="${servicio.descripcionServicio || ''}"
                       onchange="serviciosArray[${index}].descripcionServicio = this.value">
                <br>
                <label>Nivel de Riesgo:</label><br>
                <select onchange="serviciosArray[${index}].nivelRiesgo = this.value">
                    <option value="BAJO" ${servicio.nivelRiesgo === 'BAJO' ? 'selected' : ''}>Bajo</option>
                    <option value="MEDIO" ${servicio.nivelRiesgo === 'MEDIO' ? 'selected' : ''}>Medio</option>
                    <option value="ALTO" ${servicio.nivelRiesgo === 'ALTO' ? 'selected' : ''}>Alto</option>
                    <option value="ALTO_ESPECIALIZADO" ${servicio.nivelRiesgo === 'ALTO_ESPECIALIZADO' ? 'selected' : ''}>Alto Especializado</option>
                </select>
            </div>
        `).join('');
    }

    // ============================================
    // OPERACIONES CRUD
    // ============================================
    async function handleSubmit(event) {
        event.preventDefault();

        const datos = recopilarDatosFormulario();
        if (!datos) return;

        if (editandoEmpresaId) {
            await actualizarEmpresa(editandoEmpresaId, datos);
        } else {
            await crearEmpresa(datos);
        }
    }

    function recopilarDatosFormulario() {
        const tipoSeleccionado = document.querySelector('input[name="tipoContratista"]:checked');

        if (!tipoSeleccionado) {
            mostrarMensaje('Debe seleccionar un tipo de contratista', 'error');
            return null;
        }

        return {
            ruc: document.getElementById('ruc').value.trim(),
            razonSocial: document.getElementById('razonSocial').value.trim(),
            direccion: document.getElementById('direccion').value.trim() || null,
            sector: document.getElementById('sector').value || null,
            scoreSeguridad: parseInt(document.getElementById('scoreSeguridad').value) || null,
            contactos: contactosArray.filter(c => c.nombreContacto || c.telefono || c.email),
            servicios: serviciosArray.filter(s => s.descripcionServicio),
            tipoContratistaId: tipoSeleccionado.value
        };
    }

    async function crearEmpresa(datos) {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                mostrarMensaje('Empresa creada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Error al crear empresa');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al crear la empresa: ' + error.message, 'error');
        }
    }

    async function actualizarEmpresa(empresaId, datos) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'PUT',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                mostrarMensaje('Empresa actualizada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                throw new Error('Error al actualizar');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al actualizar la empresa', 'error');
        }
    }

    async function editarEmpresa(empresaId) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresa = await response.json();
                cargarDatosEnFormulario(empresa);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar datos de la empresa', 'error');
        }
    }

    async function eliminarEmpresa(empresaId) {
        if (!confirm('¬øEst√° seguro de eliminar esta empresa?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje('Empresa eliminada exitosamente', 'success');
                await cargarEmpresas();
            } else {
                throw new Error('Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al eliminar la empresa', 'error');
        }
    }

    async function toggleActivoEmpresa(empresaId, estadoActual) {
        const accion = estadoActual ? 'inactivar' : 'activar';

        if (!confirm(`¬øEst√° seguro que desea ${accion} esta empresa?`)) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}/toggle-activo`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje(`Empresa ${estadoActual ? 'inactivada' : 'activada'} exitosamente`, 'success');
                await cargarEmpresas();
            } else {
                throw new Error('Error al cambiar estado');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cambiar el estado de la empresa', 'error');
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function cargarDatosEnFormulario(empresa) {
        editandoEmpresaId = empresa.empresaId;

        document.getElementById('empresaId').value = empresa.empresaId;
        document.getElementById('ruc').value = empresa.ruc;
        document.getElementById('razonSocial').value = empresa.razonSocial;
        document.getElementById('direccion').value = empresa.direccion || '';
        document.getElementById('sector').value = empresa.sector || '';
        document.getElementById('scoreSeguridad').value = empresa.scoreSeguridad || '';

        contactosArray = empresa.contactos || [];
        renderContactos();

        serviciosArray = empresa.servicios || [];
        renderServicios();

        if (empresa.tipos && empresa.tipos.length > 0) {
            const tipoId = empresa.tipos[0].tipoId;
            const radio = document.querySelector(`input[name="tipoContratista"][value="${tipoId}"]`);
            if (radio) radio.checked = true;
        }

        document.getElementById('formTitle').textContent = '‚úèÔ∏è Editar Empresa';
        document.getElementById('submitBtn').textContent = 'Actualizar Empresa';
        document.getElementById('cancelBtn').style.display = 'inline-block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function limpiarFormulario() {
        editandoEmpresaId = null;

        document.getElementById('empresaForm').reset();
        document.getElementById('empresaId').value = '';

        contactosArray = [];
        renderContactos();

        serviciosArray = [];
        renderServicios();

        document.querySelectorAll('input[name="tipoContratista"]').forEach(radio => {
            radio.checked = false;
        });

        document.getElementById('formTitle').textContent = '‚ú® Crear Nueva Empresa';
        document.getElementById('submitBtn').textContent = 'Crear Empresa';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function cancelarEdicion() {
        limpiarFormulario();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mostrarMensaje(texto, tipo) {
        const container = document.getElementById('mensajeContainer');
        const mensaje = document.createElement('div');
        mensaje.className = `mensaje ${tipo}`;
        mensaje.textContent = texto;

        container.innerHTML = '';
        container.appendChild(mensaje);

        setTimeout(() => {
            mensaje.remove();
        }, 5000);
    }

    function getAuthHeaders() {
        return {
            'X-Tenant-ID': 'tenant_a'
        };
    }
</script>

</body>
</html>
