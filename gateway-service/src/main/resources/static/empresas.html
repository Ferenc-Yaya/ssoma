<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Empresas - SSOMA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .seccion { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .contacto-item, .servicio-item { background: #f5f5f5; padding: 10px; margin: 5px 0; border-left: 3px solid #007bff; }
        .btn { padding: 8px 15px; margin: 5px; cursor: pointer; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-secondary { background: #6c757d; color: white; border: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; font-weight: bold; }
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mensaje.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        input, select, textarea { padding: 5px; margin: 3px 0; width: 100%; max-width: 400px; }
        .radio-group { display: flex; gap: 20px; margin: 10px 0; }
        .radio-item { display: flex; align-items: center; cursor: pointer; }
        .radio-item input[type="radio"] { width: auto; margin-right: 8px; }
        .header-bar { background: #343a40; color: white; padding: 10px 20px; margin: -20px -20px 20px -20px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 15px; }
    </style>
</head>
<body>

<!-- Barra superior con informaci√≥n de usuario -->
<div class="header-bar">
    <div>
        <h2 style="margin: 0;">üè¢ Gesti√≥n de Empresas - SSOMA</h2>
    </div>
    <div class="user-info">
        <span id="userDisplay">Cargando...</span>
        <button class="btn btn-danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
</div>

<!-- ============================================ -->
<!-- FORMULARIO DE CREACI√ìN/EDICI√ìN -->
<!-- ============================================ -->
<div class="seccion">
    <h2 id="formTitle">‚ú® Crear Nueva Empresa</h2>
    <form id="empresaForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="empresaId">

        <!-- DATOS B√ÅSICOS -->
        <h3>üìã Datos B√°sicos</h3>
        <p>
            <label><strong>RUC:</strong> (m√°ximo 20 caracteres) *</label><br>
            <input type="text" id="ruc" maxlength="20" required>
        </p>
        <p>
            <label><strong>Raz√≥n Social:</strong> *</label><br>
            <input type="text" id="razonSocial" maxlength="200" required>
        </p>
        <p>
            <label><strong>Direcci√≥n:</strong></label><br>
            <input type="text" id="direccion" maxlength="255">
        </p>
        <p>
            <label><strong>Sector:</strong></label><br>
            <select id="sector">
                <option value="">Seleccione...</option>
                <option value="Construcci√≥n">Construcci√≥n</option>
                <option value="Miner√≠a">Miner√≠a</option>
                <option value="Manufactura">Manufactura</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                <option value="Servicios">Servicios</option>
                <option value="Agricultura">Agricultura</option>
                <option value="Comercio">Comercio</option>
                <option value="Transporte">Transporte</option>
                <option value="Energ√≠a">Energ√≠a</option>
                <option value="Otros">Otros</option>
            </select>
        </p>
        <p>
            <label><strong>Score de Seguridad SSOMA (0-100):</strong></label><br>
            <input type="number" id="scoreSeguridad" min="0" max="100">
        </p>

        <!-- CONTACTOS -->
        <h3>üìû Contactos</h3>
        <div id="contactosList"></div>
        <button type="button" class="btn btn-secondary" onclick="agregarContacto()">+ Agregar Contacto</button>

        <!-- SERVICIOS -->
        <h3>üîß Servicios que Ofrece</h3>
        <div id="serviciosList"></div>
        <button type="button" class="btn btn-secondary" onclick="agregarServicio()">+ Agregar Servicio</button>

        <!-- TIPOS DE EMPRESA - RADIO BUTTONS -->
        <h3>üè≠ Tipo de Empresa *</h3>
        <div id="tiposEmpresaList" class="radio-group">
            <p>Cargando tipos de empresa...</p>
        </div>

        <br><br>
        <button type="submit" class="btn btn-primary" id="submitBtn">Crear Empresa</button>
        <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="cancelarEdicion()" style="display:none">Cancelar</button>
    </form>
</div>

<!-- ============================================ -->
<!-- LISTA DE EMPRESAS -->
<!-- ============================================ -->
<div class="seccion">
    <h2>üìä Lista de Empresas</h2>
    <button class="btn btn-primary" onclick="cargarEmpresas()">üîÑ Recargar</button>
    <button class="btn btn-success" onclick="mostrarSoloActivas()">‚úÖ Solo Activas</button>

    <div id="mensajeContainer"></div>

    <table>
        <thead>
        <tr>
            <th>RUC</th>
            <th>Raz√≥n Social</th>
            <th>Sector</th>
            <th>Score</th>
            <th>Contactos</th>
            <th>Servicios</th>
            <th>Tipo</th>
            <th>Activo</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="empresasTableBody">
        <tr><td colspan="9" style="text-align:center;">Cargando empresas...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let contactosArray = [];
    let serviciosArray = [];
    let tiposEmpresaGlobal = [];
    let editandoEmpresaId = null;

    // ============================================
    // INICIALIZACI√ìN Y VERIFICACI√ìN DE SESI√ìN
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
        // Verificar que existe un token JWT
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert('‚ö†Ô∏è Debe iniciar sesi√≥n primero');
            window.location.href = 'login.html';
            return;
        }

        // Mostrar informaci√≥n del usuario
        mostrarInfoUsuario();

        // Cargar datos
        await cargarTiposEmpresa();
        await cargarEmpresas();
    });

    function mostrarInfoUsuario() {
        const username = localStorage.getItem('username') || 'Usuario';
        const tenantId = localStorage.getItem('tenant_id') || 'tenant_a';
        document.getElementById('userDisplay').textContent = `üë§ ${username} | üè¢ ${tenantId}`;
    }

    function cerrarSesion() {
        if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('username');
            localStorage.removeItem('tenant_id');
            window.location.href = 'login.html';
        }
    }

    // ============================================
    // FUNCIONES DE CARGA DE DATOS
    // ============================================
    async function cargarTiposEmpresa() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas/tipos-empresa', {
                headers: getAuthHeaders()
            });

            if (response.status === 401 || response.status === 403) {
                alert('‚ö†Ô∏è Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                cerrarSesion();
                return;
            }

            if (response.ok) {
                tiposEmpresaGlobal = await response.json();
                mostrarTiposEmpresa();
            } else {
                throw new Error('No se pudieron cargar tipos');
            }
        } catch (error) {
            console.error('Error al cargar tipos:', error);
            mostrarMensaje('Error al cargar tipos de empresa', 'error');
        }
    }

    function mostrarTiposEmpresa() {
        const container = document.getElementById('tiposEmpresaList');

        if (!tiposEmpresaGlobal || tiposEmpresaGlobal.length === 0) {
            container.innerHTML = '<p style="color: red;">No se pudieron cargar los tipos de empresa</p>';
            return;
        }

        // Crear radio buttons (solo UNO puede ser seleccionado)
        container.innerHTML = tiposEmpresaGlobal.map(tipo => `
            <label class="radio-item">
                <input type="radio" name="tipoEmpresa" value="${tipo.tipoId}" required>
                <span>${tipo.nombre}</span>
            </label>
        `).join('');
    }

    async function cargarEmpresas() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                headers: getAuthHeaders()
            });

            if (response.status === 401 || response.status === 403) {
                alert('‚ö†Ô∏è Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                cerrarSesion();
                return;
            }

            if (response.ok) {
                const empresas = await response.json();
                renderizarTabla(empresas);
            } else {
                throw new Error('Error al cargar empresas');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar las empresas', 'error');
        }
    }

    async function mostrarSoloActivas() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresas = await response.json();
                const activas = empresas.filter(e => e.activo);
                renderizarTabla(activas);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderizarTabla(empresas) {
        const tbody = document.getElementById('empresasTableBody');

        if (!empresas || empresas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No hay empresas registradas</td></tr>';
            return;
        }

        tbody.innerHTML = empresas.map(empresa => {
            const contactosTexto = empresa.contactos && empresa.contactos.length > 0
                ? empresa.contactos.map(c => {
                    const principal = c.esPrincipal ? '‚≠ê ' : '';
                    return `${principal}${c.nombreContacto || 'Sin nombre'} - ${c.telefono || ''} - ${c.email || ''}`;
                }).join('<br>')
                : 'Sin contactos';

            const serviciosTexto = empresa.servicios && empresa.servicios.length > 0
                ? empresa.servicios.map(s => {
                    const riesgo = s.nivelRiesgo ? ` [${s.nivelRiesgo}]` : '';
                    return `${s.descripcionServicio}${riesgo}`;
                }).join('<br>')
                : 'Sin servicios';

            const tipoTexto = empresa.tipos && empresa.tipos.length > 0
                ? empresa.tipos[0].nombre
                : 'Sin tipo';

            return `
                <tr>
                    <td>${empresa.ruc}</td>
                    <td><strong>${empresa.razonSocial}</strong></td>
                    <td>${empresa.sector || '-'}</td>
                    <td>${empresa.scoreSeguridad !== null ? empresa.scoreSeguridad : '-'}</td>
                    <td style="font-size: 0.9em;">${contactosTexto}</td>
                    <td style="font-size: 0.9em;">${serviciosTexto}</td>
                    <td><span style="background: #007bff; color: white; padding: 3px 8px; border-radius: 3px;">${tipoTexto}</span></td>
                    <td style="text-align: center;">${empresa.activo ? '‚úÖ' : '‚ùå'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editarEmpresa(${empresa.empresaId})">‚úèÔ∏è Editar</button>
                        <button class="btn ${empresa.activo ? 'btn-secondary' : 'btn-success'}"
                                onclick="toggleActivoEmpresa(${empresa.empresaId}, ${empresa.activo})">
                            ${empresa.activo ? 'üîí Inactivar' : '‚úÖ Activar'}
                        </button>
                        <button class="btn btn-danger" onclick="eliminarEmpresa(${empresa.empresaId})">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============================================
    // FUNCIONES PARA CONTACTOS
    // ============================================
    function agregarContacto() {
        contactosArray.push({
            nombreContacto: '',
            telefono: '',
            email: '',
            esPrincipal: false
        });
        renderContactos();
    }

    function eliminarContacto(index) {
        contactosArray.splice(index, 1);
        renderContactos();
    }

    function marcarContactoPrincipal(index, checked) {
        // Si se marca como principal, desmarcar todos los dem√°s
        if (checked) {
            contactosArray.forEach((c, i) => {
                c.esPrincipal = (i === index);
            });
        } else {
            // Si se desmarca, simplemente desmarcar este
            contactosArray[index].esPrincipal = false;
        }
        renderContactos();
    }

    function renderContactos() {
        const container = document.getElementById('contactosList');

        if (contactosArray.length === 0) {
            container.innerHTML = '<p style="color: #666;">No hay contactos agregados. Haga clic en "+ Agregar Contacto".</p>';
            return;
        }

        container.innerHTML = contactosArray.map((contacto, index) => `
            <div class="contacto-item">
                <strong>Contacto ${index + 1}</strong>
                <button type="button" class="btn btn-danger" style="float: right;" onclick="eliminarContacto(${index})">üóëÔ∏è Eliminar</button>

                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" ${contacto.esPrincipal ? 'checked' : ''}
                               onchange="marcarContactoPrincipal(${index}, this.checked)"
                               style="width: auto; margin: 0;">
                        <strong style="color: #007bff;">‚≠ê Contacto Principal</strong>
                    </label>
                </div>
                <br>

                <label>Nombre:</label>
                <input type="text" value="${contacto.nombreContacto || ''}"
                       onchange="contactosArray[${index}].nombreContacto = this.value"
                       placeholder="Nombre completo">
                <br>
                <label>Tel√©fono:</label>
                <input type="text" value="${contacto.telefono || ''}"
                       onchange="contactosArray[${index}].telefono = this.value"
                       placeholder="+51 999 999 999">
                <br>
                <label>Email:</label>
                <input type="email" value="${contacto.email || ''}"
                       onchange="contactosArray[${index}].email = this.value"
                       placeholder="email@empresa.com">
            </div>
        `).join('');
    }

    // ============================================
    // FUNCIONES PARA SERVICIOS
    // ============================================
    function agregarServicio() {
        serviciosArray.push({
            descripcionServicio: '',
            nivelRiesgo: ''
        });
        renderServicios();
    }

    function eliminarServicio(index) {
        serviciosArray.splice(index, 1);
        renderServicios();
    }

    function renderServicios() {
        const container = document.getElementById('serviciosList');

        if (serviciosArray.length === 0) {
            container.innerHTML = '<p style="color: #666;">No hay servicios agregados. Haga clic en "+ Agregar Servicio".</p>';
            return;
        }

        container.innerHTML = serviciosArray.map((servicio, index) => `
            <div class="servicio-item">
                <strong>Servicio ${index + 1}</strong>
                <button type="button" class="btn btn-danger" style="float: right;" onclick="eliminarServicio(${index})">üóëÔ∏è Eliminar</button>
                <br><br>
                <label>Descripci√≥n:</label>
                <input type="text" value="${servicio.descripcionServicio || ''}"
                       onchange="serviciosArray[${index}].descripcionServicio = this.value"
                       placeholder="Ej: Servicios de construcci√≥n civil">
                <br>
                <label>Nivel de Riesgo:</label>
                <select onchange="serviciosArray[${index}].nivelRiesgo = this.value">
                    <option value="">Seleccione...</option>
                    <option value="BAJO" ${servicio.nivelRiesgo === 'BAJO' ? 'selected' : ''}>BAJO</option>
                    <option value="MEDIO" ${servicio.nivelRiesgo === 'MEDIO' ? 'selected' : ''}>MEDIO</option>
                    <option value="ALTO" ${servicio.nivelRiesgo === 'ALTO' ? 'selected' : ''}>ALTO</option>
                    <option value="ALTO_ESPECIALIZADO" ${servicio.nivelRiesgo === 'ALTO_ESPECIALIZADO' ? 'selected' : ''}>ALTO ESPECIALIZADO</option>
                </select>
            </div>
        `).join('');
    }

    // ============================================
    // FUNCIONES CRUD
    // ============================================
    async function handleSubmit(event) {
        event.preventDefault();

        const datos = recopilarDatosFormulario();
        if (!datos) return;

        if (editandoEmpresaId) {
            await actualizarEmpresa(editandoEmpresaId, datos);
        } else {
            await crearEmpresa(datos);
        }
    }

    function recopilarDatosFormulario() {
        const tipoSeleccionado = document.querySelector('input[name="tipoEmpresa"]:checked');

        if (!tipoSeleccionado) {
            mostrarMensaje('Debe seleccionar un tipo de empresa', 'error');
            return null;
        }

        return {
            ruc: document.getElementById('ruc').value.trim(),
            razonSocial: document.getElementById('razonSocial').value.trim(),
            direccion: document.getElementById('direccion').value.trim() || null,
            sector: document.getElementById('sector').value || null,
            scoreSeguridad: parseInt(document.getElementById('scoreSeguridad').value) || null,
            contactos: contactosArray.filter(c => c.nombreContacto || c.telefono || c.email),
            servicios: serviciosArray.filter(s => s.descripcionServicio),
            tipoEmpresaId: tipoSeleccionado.value
        };
    }

    async function crearEmpresa(datos) {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });

            if (response.status === 401 || response.status === 403) {
                alert('‚ö†Ô∏è Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                cerrarSesion();
                return;
            }

            if (response.ok) {
                mostrarMensaje('Empresa creada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Error al crear empresa');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al crear la empresa: ' + error.message, 'error');
        }
    }

    async function actualizarEmpresa(empresaId, datos) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'PUT',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            });

            if (response.status === 401 || response.status === 403) {
                alert('‚ö†Ô∏è Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.');
                cerrarSesion();
                return;
            }

            if (response.ok) {
                mostrarMensaje('Empresa actualizada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                throw new Error('Error al actualizar');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al actualizar la empresa', 'error');
        }
    }

    async function editarEmpresa(empresaId) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresa = await response.json();
                cargarDatosEnFormulario(empresa);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar datos de la empresa', 'error');
        }
    }

    async function eliminarEmpresa(empresaId) {
        if (!confirm('¬øEst√° seguro de eliminar esta empresa?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje('Empresa eliminada exitosamente', 'success');
                await cargarEmpresas();
            } else {
                throw new Error('Error al eliminar');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al eliminar la empresa', 'error');
        }
    }

    async function toggleActivoEmpresa(empresaId, estadoActual) {
        const accion = estadoActual ? 'inactivar' : 'activar';

        if (!confirm(`¬øEst√° seguro que desea ${accion} esta empresa?`)) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}/toggle-activo`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje(`Empresa ${estadoActual ? 'inactivada' : 'activada'} exitosamente`, 'success');
                await cargarEmpresas();
            } else {
                throw new Error('Error al cambiar estado');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cambiar el estado de la empresa', 'error');
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function cargarDatosEnFormulario(empresa) {
        editandoEmpresaId = empresa.empresaId;

        document.getElementById('empresaId').value = empresa.empresaId;
        document.getElementById('ruc').value = empresa.ruc;
        document.getElementById('razonSocial').value = empresa.razonSocial;
        document.getElementById('direccion').value = empresa.direccion || '';
        document.getElementById('sector').value = empresa.sector || '';
        document.getElementById('scoreSeguridad').value = empresa.scoreSeguridad || '';

        contactosArray = empresa.contactos || [];
        renderContactos();

        serviciosArray = empresa.servicios || [];
        renderServicios();

        if (empresa.tipos && empresa.tipos.length > 0) {
            const tipoId = empresa.tipos[0].tipoId;
            const radio = document.querySelector(`input[name="tipoEmpresa"][value="${tipoId}"]`);
            if (radio) radio.checked = true;
        }

        document.getElementById('formTitle').textContent = '‚úèÔ∏è Editar Empresa';
        document.getElementById('submitBtn').textContent = 'Actualizar Empresa';
        document.getElementById('cancelBtn').style.display = 'inline-block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function limpiarFormulario() {
        editandoEmpresaId = null;

        document.getElementById('empresaForm').reset();
        document.getElementById('empresaId').value = '';

        contactosArray = [];
        renderContactos();

        serviciosArray = [];
        renderServicios();

        document.querySelectorAll('input[name="tipoEmpresa"]').forEach(radio => {
            radio.checked = false;
        });

        document.getElementById('formTitle').textContent = '‚ú® Crear Nueva Empresa';
        document.getElementById('submitBtn').textContent = 'Crear Empresa';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function cancelarEdicion() {
        limpiarFormulario();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mostrarMensaje(texto, tipo) {
        const container = document.getElementById('mensajeContainer');
        const mensaje = document.createElement('div');
        mensaje.className = `mensaje ${tipo}`;
        mensaje.textContent = texto;

        container.innerHTML = '';
        container.appendChild(mensaje);

        setTimeout(() => {
            mensaje.remove();
        }, 5000);
    }

    // ============================================
    // FUNCI√ìN CR√çTICA: HEADERS CON JWT
    // ============================================
    function getAuthHeaders() {
        const token = localStorage.getItem('jwt_token');
        const tenantId = localStorage.getItem('tenant_id') || 'tenant_a';

        const headers = {
            'X-Tenant-ID': tenantId
        };

        // Agregar el token JWT si existe
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return headers;
    }
</script>

</body>
</html>
