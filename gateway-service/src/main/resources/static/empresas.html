<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Empresas</title>
</head>
<body>
<h1>Gestión de Empresas Contratistas</h1>

<p>
    Usuario: <span id="username">-</span> |
    Tenant: <span id="tenantId">-</span> |
    <a href="#" onclick="cerrarSesion()">Cerrar Sesión</a>
</p>

<hr>

<h2>Navegación</h2>
<p>
    <a href="/dashboard.html">Volver al Dashboard</a>
</p>

<hr>

<!-- CREAR EMPRESA -->
<h2 id="formTitle">Crear Nueva Empresa</h2>

<form id="empresaForm" onsubmit="handleSubmit(event)">
    <input type="hidden" id="empresaId">

    <p>
        <strong>RUC:</strong><br>
        <input type="text" id="ruc" maxlength="11" required>
    </p>

    <p>
        <strong>Razón Social:</strong><br>
        <input type="text" id="razonSocial" maxlength="200" required>
    </p>

    <p>
        <strong>Dirección:</strong><br>
        <input type="text" id="direccion" maxlength="255">
    </p>

    <p>
        <strong>Sitio Web:</strong><br>
        <input type="url" id="sitioWeb" maxlength="255">
    </p>

    <p>
        <strong>Rubro Comercial:</strong><br>
        <select id="rubroComercial">
            <option value="">Seleccione...</option>
            <option value="Construcción">Construcción</option>
            <option value="Minería">Minería</option>
            <option value="Manufactura">Manufactura</option>
            <option value="Servicios">Servicios</option>
            <option value="Otros">Otros</option>
        </select>
    </p>

    <p>
        <strong>Score de Seguridad (0-100):</strong><br>
        <input type="number" id="scoreSeguridad" min="0" max="100" step="0.01">
    </p>

    <p>
        <strong>Estado de Habilitación:</strong><br>
        <select id="estadoHabilitacion" required>
            <option value="PENDIENTE">Pendiente</option>
            <option value="HABILITADO">Habilitado</option>
            <option value="SUSPENDIDO">Suspendido</option>
            <option value="RECHAZADO">Rechazado</option>
        </select>
    </p>

    <p>
        <strong>Tipo de Contratista:</strong><br>
        <select id="tipoContratista" required>
            <option value="">Cargando tipos...</option>
        </select>
    </p>

    <h3>Contactos</h3>
    <div id="contactosList" style="margin-left: 20px;">
        <p>No hay contactos agregados.</p>
    </div>
    <p>
        <button type="button" onclick="agregarContacto()">+ Agregar Contacto</button>
    </p>

    <p>
        <button type="submit" id="submitBtn">Crear Empresa</button>
        <button type="button" id="cancelBtn" onclick="cancelarEdicion()" style="display:none;">Cancelar</button>
    </p>
</form>

<hr>

<!-- LISTA DE EMPRESAS -->
<h2>Lista de Empresas</h2>

<p>
    <button onclick="cargarEmpresas()">Refrescar</button>
    <button onclick="mostrarSoloActivas()">Solo Activas</button>
</p>

<div id="mensajeContainer"></div>

<table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
    <thead>
    <tr>
        <th>RUC</th>
        <th>Razón Social</th>
        <th>Rubro</th>
        <th>Score</th>
        <th>Estado</th>
        <th>Tipo</th>
        <th>Contactos</th>
        <th>Activo</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody id="empresasTableBody">
    <tr>
        <td colspan="9" style="text-align:center;">Cargando empresas...</td>
    </tr>
    </tbody>
</table>

<script>
    let contactosArray = [];
    let tiposContratistaGlobal = [];
    let editandoEmpresaId = null;

    // INICIALIZACIÓN
    document.addEventListener('DOMContentLoaded', async function() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert('Debe iniciar sesión primero');
            window.location.href = '/login.html';
            return;
        }

        document.getElementById('username').textContent = localStorage.getItem('username') || '-';
        document.getElementById('tenantId').textContent = localStorage.getItem('tenant_id') || '-';

        await cargarTiposContratista();
        await cargarEmpresas();
    });

    function cerrarSesion() {
        if (confirm('¿Cerrar sesión?')) {
            localStorage.clear();
            window.location.href = '/login.html';
        }
    }

    // CARGAR TIPOS DE CONTRATISTA
    async function cargarTiposContratista() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas/tipos-contratista', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                tiposContratistaGlobal = await response.json();
                const select = document.getElementById('tipoContratista');
                select.innerHTML = '<option value="">Seleccione un tipo...</option>';

                tiposContratistaGlobal.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.tipoId;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
                });
            } else {
                throw new Error('Error al cargar tipos');
            }
        } catch (error) {
            console.error('Error:', error);
            const select = document.getElementById('tipoContratista');
            select.innerHTML = '<option value="">Error al cargar tipos</option>';
        }
    }

    // CARGAR EMPRESAS
    async function cargarEmpresas() {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresas = await response.json();
                mostrarEmpresas(empresas);
            } else {
                throw new Error('Error al cargar empresas');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar empresas', 'error');
        }
    }

    function mostrarEmpresas(empresas) {
        const tbody = document.getElementById('empresasTableBody');

        if (!empresas || empresas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No hay empresas registradas</td></tr>';
            return;
        }

        tbody.innerHTML = empresas.map(e => {
            const contactos = e.contactos && e.contactos.length > 0
                ? e.contactos.map(c => c.nombreCompleto).join(', ')
                : 'Sin contactos';

            return `
                <tr>
                    <td>${e.ruc}</td>
                    <td>${e.razonSocial}</td>
                    <td>${e.rubroComercial || '-'}</td>
                    <td>${e.scoreSeguridad || '-'}</td>
                    <td>${e.estadoHabilitacion || '-'}</td>
                    <td>${e.tipo ? e.tipo.nombre : '-'}</td>
                    <td>${contactos}</td>
                    <td>${e.activo ? 'Sí' : 'No'}</td>
                    <td>
                        <button onclick="editarEmpresa('${e.empresaId}')">Editar</button>
                        <button onclick="toggleActivoEmpresa('${e.empresaId}', ${e.activo})">${e.activo ? 'Inactivar' : 'Activar'}</button>
                        <button onclick="eliminarEmpresa('${e.empresaId}')">Eliminar</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function mostrarSoloActivas() {
        const response = await fetch('http://localhost:8080/api/empresas', { headers: getAuthHeaders() });
        if (response.ok) {
            const todas = await response.json();
            mostrarEmpresas(todas.filter(e => e.activo === true));
        }
    }

    // CONTACTOS
    function agregarContacto() {
        contactosArray.push({
            nombreCompleto: '',
            cargo: '',
            tipoContacto: 'RESPONSABLE_EHS',
            email: '',
            telefono: '',
            esPrincipal: false
        });
        renderContactos();
    }

    function eliminarContacto(index) {
        contactosArray.splice(index, 1);
        renderContactos();
    }

    function renderContactos() {
        const container = document.getElementById('contactosList');

        if (contactosArray.length === 0) {
            container.innerHTML = '<p>No hay contactos agregados.</p>';
            return;
        }

        container.innerHTML = contactosArray.map((c, i) => `
            <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                <p><strong>Contacto ${i + 1}</strong> <button type="button" onclick="eliminarContacto(${i})">Eliminar</button></p>
                <p>
                    Nombre Completo: <input type="text" value="${c.nombreCompleto || ''}"
                           onchange="contactosArray[${i}].nombreCompleto = this.value" required>
                </p>
                <p>
                    Cargo: <input type="text" value="${c.cargo || ''}"
                           onchange="contactosArray[${i}].cargo = this.value">
                </p>
                <p>
                    Tipo:
                    <select onchange="contactosArray[${i}].tipoContacto = this.value">
                        <option value="REPRESENTANTE_LEGAL" ${c.tipoContacto === 'REPRESENTANTE_LEGAL' ? 'selected' : ''}>Representante Legal</option>
                        <option value="RESPONSABLE_EHS" ${c.tipoContacto === 'RESPONSABLE_EHS' ? 'selected' : ''}>Responsable EHS</option>
                        <option value="ADMIN_CONTRATO" ${c.tipoContacto === 'ADMIN_CONTRATO' ? 'selected' : ''}>Admin Contrato</option>
                    </select>
                </p>
                <p>
                    Email: <input type="email" value="${c.email || ''}"
                           onchange="contactosArray[${i}].email = this.value">
                </p>
                <p>
                    Teléfono: <input type="tel" value="${c.telefono || ''}"
                           onchange="contactosArray[${i}].telefono = this.value">
                </p>
                <p>
                    <input type="checkbox" ${c.esPrincipal ? 'checked' : ''}
                           onchange="contactosArray[${i}].esPrincipal = this.checked">
                    Contacto Principal
                </p>
            </div>
        `).join('');
    }

    // SUBMIT
    async function handleSubmit(event) {
        event.preventDefault();

        const tipoId = document.getElementById('tipoContratista').value;
        if (!tipoId) {
            alert('Debe seleccionar un tipo de contratista');
            return;
        }

        const datos = {
            ruc: document.getElementById('ruc').value.trim(),
            razonSocial: document.getElementById('razonSocial').value.trim(),
            direccion: document.getElementById('direccion').value.trim() || null,
            sitioWeb: document.getElementById('sitioWeb').value.trim() || null,
            rubroComercial: document.getElementById('rubroComercial').value || null,
            scoreSeguridad: document.getElementById('scoreSeguridad').value ? parseFloat(document.getElementById('scoreSeguridad').value) : null,
            estadoHabilitacion: document.getElementById('estadoHabilitacion').value,
            tipoId: tipoId,
            contactos: contactosArray.filter(c => c.nombreCompleto.trim() !== '')
        };

        if (editandoEmpresaId) {
            await actualizarEmpresa(editandoEmpresaId, datos);
        } else {
            await crearEmpresa(datos);
        }
    }

    async function crearEmpresa(datos) {
        try {
            const response = await fetch('http://localhost:8080/api/empresas', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                mostrarMensaje('Empresa creada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                const error = await response.text();
                throw new Error(error);
            }
        } catch (error) {
            mostrarMensaje('Error: ' + error.message, 'error');
        }
    }

    async function actualizarEmpresa(empresaId, datos) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'PUT',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            if (response.ok) {
                mostrarMensaje('Empresa actualizada exitosamente', 'success');
                limpiarFormulario();
                await cargarEmpresas();
            } else {
                throw new Error('Error al actualizar');
            }
        } catch (error) {
            mostrarMensaje('Error: ' + error.message, 'error');
        }
    }

    async function editarEmpresa(empresaId) {
        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const empresa = await response.json();
                cargarDatosEnFormulario(empresa);
            }
        } catch (error) {
            mostrarMensaje('Error al cargar empresa', 'error');
        }
    }

    async function eliminarEmpresa(empresaId) {
        if (!confirm('¿Está seguro de eliminar esta empresa?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje('Empresa eliminada exitosamente', 'success');
                await cargarEmpresas();
            }
        } catch (error) {
            mostrarMensaje('Error al eliminar', 'error');
        }
    }

    async function toggleActivoEmpresa(empresaId, estadoActual) {
        const accion = estadoActual ? 'inactivar' : 'activar';
        if (!confirm(`¿Está seguro que desea ${accion} esta empresa?`)) return;

        try {
            const response = await fetch(`http://localhost:8080/api/empresas/${empresaId}/toggle-activo`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                mostrarMensaje(`Empresa ${estadoActual ? 'inactivada' : 'activada'} exitosamente`, 'success');
                await cargarEmpresas();
            }
        } catch (error) {
            mostrarMensaje('Error al cambiar estado', 'error');
        }
    }

    function cargarDatosEnFormulario(empresa) {
        editandoEmpresaId = empresa.empresaId;

        document.getElementById('empresaId').value = empresa.empresaId;
        document.getElementById('ruc').value = empresa.ruc;
        document.getElementById('razonSocial').value = empresa.razonSocial;
        document.getElementById('direccion').value = empresa.direccion || '';
        document.getElementById('sitioWeb').value = empresa.sitioWeb || '';
        document.getElementById('rubroComercial').value = empresa.rubroComercial || '';
        document.getElementById('scoreSeguridad').value = empresa.scoreSeguridad || '';
        document.getElementById('estadoHabilitacion').value = empresa.estadoHabilitacion || 'PENDIENTE';

        if (empresa.tipo && empresa.tipo.tipoId) {
            document.getElementById('tipoContratista').value = empresa.tipo.tipoId;
        }

        contactosArray = empresa.contactos || [];
        renderContactos();

        document.getElementById('formTitle').textContent = 'Editar Empresa';
        document.getElementById('submitBtn').textContent = 'Actualizar Empresa';
        document.getElementById('cancelBtn').style.display = 'inline-block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function limpiarFormulario() {
        editandoEmpresaId = null;
        document.getElementById('empresaForm').reset();
        contactosArray = [];
        renderContactos();
        document.getElementById('formTitle').textContent = 'Crear Nueva Empresa';
        document.getElementById('submitBtn').textContent = 'Crear Empresa';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function cancelarEdicion() {
        limpiarFormulario();
    }

    function mostrarMensaje(texto, tipo) {
        const container = document.getElementById('mensajeContainer');
        const color = tipo === 'success' ? 'green' : 'red';
        container.innerHTML = `<p style="color: ${color}; font-weight: bold;">${texto}</p>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }

    function getAuthHeaders() {
        const token = localStorage.getItem('jwt_token');
        const tenantId = localStorage.getItem('tenant_id') || 'SYSTEM';

        const headers = { 'X-Tenant-ID': tenantId };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        return headers;
    }
</script>
</body>
</html>